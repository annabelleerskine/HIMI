---
title: toothfish project
author: RF
output:
  html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(mizer)
library(mizerExperimental)
library(mizerHowTo)
library(therMizer)
library(parallel)
library(tictoc)
load("inputs/size_spec_inputs.RData")
source("functions.R")

myTheme <- function(){
     theme(
        legend.key = element_rect(fill = "white"),
        legend.position = "bottom",
        panel.background = element_rect(fill = "white", color = "black"),
        strip.background = element_blank(),
        panel.grid.minor = element_line(colour = "grey92"))
}

fig_width = 15
fig_height =10
```


# % difference between modelled and observed biomass

```{r}

# we are comparing with the equilibrium state with average fishing

sim <- readRDS("params/params9.RDS")

params <- sim@params

ll_area_yr <- read_csv("inputs/ll_area_yr.csv")

ll_trends <- cbind(ll_trends,ll_area_yr[-dim(ll_area_yr)[1],3])

ll_km2 <- data.frame("year" = ll_trends$Year, "effort" = ll_trends$Effort/ll_trends$area_km,
                     "catchT" = ll_trends$CatchT / ll_trends$area_km)
ll_km2$catchT <- ll_km2$catchT * 1e6 #in grams
ll_avg <- mean(ll_km2$catchT)
effort_avg <-mean(ll_km2$effort)

  effort <-array(ll_km2$effort, dim = c(length(ll_km2$effort),1), 
                 dimnames = list("time" = ll_km2$year, "gear" = params@gear_params$gear[1]))

params@species_params$yield_observed <- c(ll_avg,rep(0,8))

gear_ll<-data.frame(species = params@species_params$species,
               gear = "longline",
               sel_func = "knife_edge",
               knife_edge_size = 2722 ,
               catchability = c(7e-7,rep(0,8)),
               initial_effort = 1)

gear_params(params) <- gear_ll
initial_effort(params) <- effort_avg # somehow doesn't work with gear_params

sim <- project(params, t_max = 200)

myData <- plotBiomassObservedVsModelCustom(sim,return_data = T)

summary(myData$ratio)

```

# Slope of the size spectrum

```{r}
myData <- mizer::plotSpectra(sim, total = T, return_data = T)

spectrum <- filter(myData, Species == "Total")

lm(log10(w)~log10(value), data =  spectrum)

```

# Maximum prediction temperature increase

ssp126

```{r}

myData <- readRDS("~/RstudioProjects/FISHMIP/data/processed/IPSL_ocean_temp_array_CCscenario_126.RDS")[,1]

plot(myData)

a <- summary(myData[1:10])[3]
b <- summary(myData[134:144])[3]
b-a
```


ssp585

```{r}

myData <- readRDS("~/RstudioProjects/FISHMIP/data/processed/IPSL_ocean_temp_array_CCscenario_585.RDS")[,1]

plot(myData)

a <- summary(myData[1:10])[3]
b <- summary(myData[134:144])[3]
b-a
```


# Analysis of proportional change figure

Redoing temperature setup


```{r}
sim <- readRDS("params/params10.RDS")
params <- sim@params
first_year <- 1950
last_year <- 2093
times <- seq(first_year,last_year, by = 1)

## Setting up temperature range

species_params(params)$temp_min <- c(1.8,-1.1,1.3,1.3,-0.1,-1.8,1.4,1.8,1.6) # fishbase
# species_params(params)$temp_min <- c(1.4,-1.1,1.3,1.3,-0.1,-1.8,1.4,1.4,1.4) # adjusted so species survive historical temperatures

# species_params(params)$temp_max <- c(8.8,2.9,2.5,2.8,1.4,2,2.3,3.1,3.9) #fishbase
species_params(params)$temp_max <-   c(8.8,2.9,2.5,2.8,2.4,2.4,2.3,3.1,3.9) # adjusted


## Time index
other_params(params)$t_idx = -1949 # temperature array starts at 1950 so any time generated by the effort array will match the rownumber of the temperature array

## Create parameter for scaling encounter and mortality rates so scalar is always between 0 and 1
species_params(params)$encounterpred_scale <- 
    rep(NA, nrow(species_params(params)))

for (indv in seq(1:length(species_params(params)$temp_min))) {
    
    # Create a vector of all temperatures each species might encounter
    temperature <- seq(species_params(params)$temp_min[indv], 
                       species_params(params)$temp_max[indv], 
                       by = 0.1)
    
    # Find the maximum value of the unscaled effect of temperature on encounter
    # and predation rate for each species 
  species_params(params)$encounterpred_scale[indv] <- 
      max((temperature) * 
              (temperature - species_params(params)$temp_min[indv]) *
              (species_params(params)$temp_max[indv] - temperature)
          )
}

## Determine the minimum, maximum, and range of value for the effect of 
# temperature on metabolism
    
min_metab_value <- 
    (exp(25.22 - (0.63/((8.62e-5)*(273 + species_params(params)$temp_min)))))
max_metab_value <- 
    (exp(25.22 - (0.63/((8.62e-5)*(273 + species_params(params)$temp_max)))))
    
species_params(params)$metab_min <- min_metab_value
species_params(params)$metab_range <- max_metab_value - min_metab_value


params <- setRateFunction(params, "Encounter", "therMizerEncounter")
params <- setRateFunction(params, "PredRate", "therMizerPredRate")
params <- setRateFunction(params, "EReproAndGrowth", "therMizerEReproAndGrowth")

params <- setResource(params, resource_dynamics = "plankton_forcing")


ll_area_yr <- read_csv("inputs/ll_area_yr.csv")

ll_trends <- cbind(ll_trends,ll_area_yr[-dim(ll_area_yr)[1],3])

ll_km2 <- data.frame("year" = ll_trends$Year, "effort" = ll_trends$Effort/ll_trends$area_km,
                     "catchT" = ll_trends$CatchT / ll_trends$area_km)
ll_km2$catchT <- ll_km2$catchT * 1e6 #in grams
ll_avg <- mean(ll_km2$catchT)
effort_avg <-mean(ll_km2$effort)

effort <-array(ll_km2$effort, dim = c(length(ll_km2$effort),1), 
                 dimnames = list("time" = ll_km2$year, "gear" = params@gear_params$gear[1]))

# Create parameter objects
params_IPSL_picontrol <- params
params_IPSL_ssp1rcp26 <- params
params_IPSL_ssp5rcp85 <- params

# Attach temperature
other_params(params_IPSL_picontrol)$ocean_temp <- readRDS("~/RstudioProjects/FISHMIP/data/processed/IPSL_ocean_temp_array_PIcontrol.RDS")
other_params(params_IPSL_ssp1rcp26)$ocean_temp <- readRDS("~/RstudioProjects/FISHMIP/data/processed/IPSL_ocean_temp_array_CCscenario_126.RDS")
other_params(params_IPSL_ssp5rcp85)$ocean_temp <- readRDS("~/RstudioProjects/FISHMIP/data/processed/IPSL_ocean_temp_array_CCscenario_585.RDS")

# Attach plankton
other_params(params_IPSL_picontrol)$n_pp_array <- readRDS("~/RstudioProjects/FISHMIP/data/processed/IPSL_n_pp_array_PIcontrol.RDS")
other_params(params_IPSL_ssp1rcp26)$n_pp_array <- readRDS("~/RstudioProjects/FISHMIP/data/processed/IPSL_n_pp_array_CCscenario_126.RDS")
other_params(params_IPSL_ssp5rcp85)$n_pp_array <- readRDS("~/RstudioProjects/FISHMIP/data/processed/IPSL_n_pp_array_CCscenario_585.RDS")


```

calculating average biomass for each species from 2000 to 2009

```{r}

sim <- project(params_IPSL_ssp1rcp26,initial_n_pp = params_IPSL_ssp1rcp26@other_params$other$n_pp_array[1,],
                                      t_max = 10,t_start = 2000)

biomass <- mizer::plotBiomass(sim, return_data = T)
biom_avg <- NULL
for(iSpecies in sim@params@species_params$species){
  temp <- filter(biomass, Species == iSpecies)
  
  biom_avg <- rbind(biom_avg, mean(temp$Biomass))
}

biom_avg <- data.frame(Species = sim@params@species_params$species, biomass = biom_avg)

```

```{r}
sim <- project(params_IPSL_ssp1rcp26,initial_n_pp = params_IPSL_ssp1rcp26@other_params$other$n_pp_array[1,],
                                      t_max = length(times),t_start = 1950)

biomass <- mizer::getBiomass(sim)

biomass_relative <- apply(biomass,1,FUN = function(x){x/biom_avg$biomass})


```

4 species have extremely low biomass, counts as almost extinct or getting there, however there is a pike in their abundance at the end of the simulation. I'm assuming it is due to predation realease because of toothfish biomass going down.

Relative biomass change averaged of the last 10 years

```{r}

biom_change_ssp126 <- apply(biomass_relative[,136:145],1,mean)

```

ssp585

```{r}

sim <- project(params_IPSL_ssp5rcp85,initial_n_pp = params_IPSL_ssp5rcp85@other_params$other$n_pp_array[1,],
                                      t_max = 10,t_start = 2000)

biomass <- mizer::plotBiomass(sim, return_data = T)
biom_avg <- NULL
for(iSpecies in sim@params@species_params$species){
  temp <- filter(biomass, Species == iSpecies)
  
  biom_avg <- rbind(biom_avg, mean(temp$Biomass))
}

biom_avg <- data.frame(Species = sim@params@species_params$species, biomass = biom_avg)

```

```{r}
sim <- project(params_IPSL_ssp5rcp85,initial_n_pp = params_IPSL_ssp5rcp85@other_params$other$n_pp_array[1,],
                                      t_max = length(times),t_start = 1950)

biomass <- mizer::getBiomass(sim)

biomass_relative <- apply(biomass,1,FUN = function(x){x/biom_avg$biomass})


```


Relative biomass change averaged of the last 10 years

```{r}

biom_change_ssp585 <- apply(biomass_relative[,136:145],1,mean)

```


Ratio

```{r}


biom_change_ssp585/biom_change_ssp126

```

Temporary fix of the temperature profile for species going in the negative values

```{r}
# temperature profile

temp_vec <- seq(-1.5,9,.05) + 273
scalar <- NULL
scalarM <- NULL

# params <- sim@params
# params@species_params$temp_min[params@species_params$temp_min<0] <- 0

species_params(params)$encounterpred_scale <- 
    rep(NA, nrow(species_params(params)))

for (indv in seq(1:length(species_params(params)$temp_min))) {
  
			# Create a vector of all temperatures each species might encounter
      # Convert from degrees Celsius to Kelvin
      temperature <- seq(species_params(params)$temp_min[indv], species_params(params)$temp_max[indv], by = 0.1) + 273
      
      # Find the maximum value of the unscaled effect of temperature on encounter and predation rate for each species 
			species_params(params)$encounterpred_scale[indv] <- max((temperature) * (temperature - species_params(params)$temp_min[indv] + 273) * (species_params(params)$temp_max[indv] + 273 - temperature)^(1/2))
			
}

min_metab_value <- 
    (exp(25.22 - (0.63/((8.62e-5)*(273 + species_params(params)$temp_min)))))
max_metab_value <- 
    (exp(25.22 - (0.63/((8.62e-5)*(273 + species_params(params)$temp_max)))))
    
species_params(params)$metab_min <- min_metab_value
species_params(params)$metab_range <- max_metab_value - min_metab_value

for(iTemp in temp_vec){
  
temp_at_t <- iTemp

# temp_at_t <- temp_at_t + 273

# unscaled_temp_effect <- 
#   temp_at_t * (temp_at_t - (species_params(params)$temp_min + 273)) * 
#   (species_params(params)$temp_max - temp_at_t + 273)

    unscaled_temp_effect <- 
        temp_at_t * (temp_at_t - species_params(params)$temp_min + 273) * 
        (species_params(params)$temp_max - temp_at_t + 273)^(1/2)
    
    # Scale using new parameter
    scaled_temp_effect_r <- unscaled_temp_effect / species_params(params)$encounterpred_scale
    
    # Set temperature effect to 0 if temperatures are outside thermal tolerance limits
    above_max <- temp_at_t - 273 > species_params(params)$temp_max
    below_min <- temp_at_t - 273 < species_params(params)$temp_min
    
    scaled_temp_effect_r[above_max | below_min] = 0
# scaled_temp_effect[scaled_temp_effect < 0] = 0

scalar <- rbind(scalar,scaled_temp_effect_r)


    # Arrhenius equation
    unscaled_temp_effect <- (exp(25.22 - (0.63/((8.62e-5)*(273 + temp_at_t)))))
    
    # Arrhenius equation scaled to a value between 0 and 1
    temp_effect_metabolism <- 
        (unscaled_temp_effect - species_params(params)$metab_min) /
        species_params(params)$metab_range
    
    # Set temperature effect to 0 if temperatures are outside thermal 
    # tolerance limits
    above_max <- temp_at_t > species_params(params)$temp_max
    below_min <- temp_at_t < species_params(params)$temp_min
    temp_effect_metabolism[above_max | below_min] = 0
    
    scalarM <- rbind(scalarM, temp_effect_metabolism)

}

rownames(scalar) <- temp_vec
colnames(scalar) <- params@species_params$species
plot_dat <- reshape2::melt(scalar)
colnames(plot_dat) <- c("temperature","Species","scalar")
plot_dat$Type <- "Encounter"

# removing scalar = 0 except at the beginning and end of curve
zero_keep <- NULL
zero_val <- which(plot_dat$scalar == 0)
for(i in 1:(length(zero_val)-1)){
  if(zero_val[i+1] != zero_val[i] + 1){
    zero_keep <- c(zero_keep, i, i+1)
  }
}
# zero keep has the position of the row to keep in zero_val
zero_val <- zero_val[-zero_keep]
plot_dat <-plot_dat[- zero_val,] 

rownames(scalarM) <- temp_vec
colnames(scalarM) <- params@species_params$species
plot_datM <- reshape2::melt(scalarM)
colnames(plot_datM) <- c("temperature","Species","scalar")
# plot_datM$scalar[plot_datM$scalar == 0] <- NA
plot_datM$Type <- "Metabolism"

# removing scalar = 0 except at the beginning of curve
zero_keep <- NULL
zero_val <- which(plot_datM$scalar == 0)
for(i in 1:(length(zero_val)-1)){
  if(zero_val[i+1] != zero_val[i] + 1){
    zero_keep <- c(zero_keep, i)
  }
}
# zero keep has the position of the row to keep in zero_val
zero_val <- zero_val[-zero_keep]
plot_datM <-plot_datM[- zero_val,] 

plot_dat <- rbind(plot_dat, plot_datM)

# plot_dat[which(plot_dat$scalar == 0),]

plot_dat <- plot_dat[-780,] # for some reason that one value really wants to stay in the df

# points for current and projected temperature
temperature <- params_IPSL_ssp1rcp26@other_params$other$ocean_temp[,1]
historical <- mean(temperature[40:60])
projection <- mean(temperature[124:144])
scalar <- NULL
scalarM <- NULL
for(iTemp in c(historical,projection)){
  
temp_at_t <- iTemp

# temp_at_t <- temp_at_t + 273

# unscaled_temp_effect <- 
#   temp_at_t * (temp_at_t - (species_params(params)$temp_min + 273)) * 
#   (species_params(params)$temp_max - temp_at_t + 273)

unscaled_temp_effect <- 
  temp_at_t * (temp_at_t - (species_params(params)$temp_min)) * 
  (species_params(params)$temp_max - temp_at_t)

scaled_temp_effect <- 
  unscaled_temp_effect / species_params(params)$encounterpred_scale

above_max <- temp_at_t > species_params(params)$temp_max
below_min <- temp_at_t < species_params(params)$temp_min
scaled_temp_effect[above_max | below_min] = 0
scaled_temp_effect[scaled_temp_effect < 0] = 0

scalar <- rbind(scalar,scaled_temp_effect)


    # Arrhenius equation
    unscaled_temp_effect <- (exp(25.22 - (0.63/((8.62e-5)*(273 + temp_at_t)))))
    
    # Arrhenius equation scaled to a value between 0 and 1
    temp_effect_metabolism <- 
        (unscaled_temp_effect - species_params(params)$metab_min) /
        species_params(params)$metab_range
    
    # Set temperature effect to 0 if temperatures are outside thermal 
    # tolerance limits
    above_max <- temp_at_t > species_params(params)$temp_max
    below_min <- temp_at_t < species_params(params)$temp_min
    temp_effect_metabolism[above_max | below_min] = 0
    
    scalarM <- rbind(scalarM, temp_effect_metabolism)

}

rownames(scalar) <- c(historical,projection)
colnames(scalar) <- params@species_params$species
plot_point <- reshape2::melt(scalar)
plot_point$Scenario <- c("Historical","Projection")
colnames(plot_point)[1:3] <- c("temperature","Species","scalar")
plot_point$Type <- "Encounter"

rownames(scalarM) <- c(historical,projection)
colnames(scalarM) <- params@species_params$species
plot_pointM <- reshape2::melt(scalarM)
plot_pointM$Scenario <- c("Historical","Projection")
colnames(plot_pointM)[1:3] <- c("temperature","Species","scalar")
plot_pointM$Type <- "Metabolism"

plot_point <- rbind(plot_point, plot_pointM)

p7 <- ggplot(filter(plot_dat, Type == "Encounter"))+
  geom_line(aes(x = temperature, y = scalar, color = Type)) +
  # geom_point(data = plot_point, aes(x = temperature, y = scalar, shape = Scenario, color = Scenario), size = 2) +
  scale_x_continuous("Temperature in C")+
  scale_y_continuous("Scalar value") +
  facet_wrap(~Species, scales = "free") +
myTheme() +
  guides(color=guide_legend(nrow=2,byrow=TRUE), shape = guide_legend(nrow=2,byrow=TRUE)) +
  scale_color_manual(values = c("dodgerblue","darkgreen","green3","darkorange2"))
  
p7

# ggsave(p7, file = "figures/tempProfile.png", units = "cm", width = fig_width, height = fig_height)


```
