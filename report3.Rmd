---
title: toothfish project
author: RF
output:
  html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(mizer)
library(mizerExperimental)
library(mizerHowTo)
library(therMizer)
library(parallel)
library(tictoc)
load("size_spec_inputs.RData")
```


# Helpful functions

```{r}
# Calculate the temperature scaling factor for the encounter rate and 
# predation rate
scaled_temp_fun <- function(params, t) {
    # Using t+1 to avoid calling ocean_temp[0,] at the first time step

  # print("model time")
  # print(t)
  # print("adjusted time")
  # print(t + params@other_params$other$t_idx)
  # print("temperature")
  # print(other_params(params)$ocean_temp)
    if(t == 0) temp_at_t <- other_params(params)$ocean_temp[t + 1,]
    else temp_at_t <- other_params(params)$ocean_temp[t + params@other_params$other$t_idx,]

    # print("temperature in scaled_temp")
    # print(temp_at_t)
    
    # Calculate unscaled temperature effect using a generic polynomial rate equation
    unscaled_temp_effect <- 
        temp_at_t * (temp_at_t - species_params(params)$temp_min) * 
        (species_params(params)$temp_max - temp_at_t)
    
    # Scale using new parameter
    scaled_temp_effect <- 
        unscaled_temp_effect / species_params(params)$encounterpred_scale
    # print("intermediate temp effect")
    # print(scaled_temp_effect)
    # Set temperature effect to 0 if temperatures are outside thermal 
    # tolerance limits
    above_max <- temp_at_t > species_params(params)$temp_max
    below_min <- temp_at_t < species_params(params)$temp_min
    scaled_temp_effect[above_max | below_min] = 0
    
    # print("temp effect")
    # print(scaled_temp_effect)
    
    return(scaled_temp_effect)
}


therMizerEncounter <- function(params, t, ...) {
    
      # Calculate maximum possible encounter rate
      max_encounter <- mizerEncounter(params, t, ...)
      
      # Apply temperature effect
      return(max_encounter * scaled_temp_fun(params, t))
      
}

therMizerPredRate <- function(params, t, ...) {
      # Calculate maximum possible encounter rate
      max_predrate <- mizerPredRate(params, t, ...)
      # print("predrate")
      # print(max_predrate)
      # Apply temperature effect
      return(max_predrate * scaled_temp_fun(params, t))
      
}


therMizerEReproAndGrowth <- function(params, t, encounter, feeding_level, ...) {
    
  # print("t")
  # print(t)
  # print("emcounter")
  # print(encounter)
  # print("feeding")
  # print(feeding_level)
  
    # Using t+1 to avoid calling ocean_temp[0,] at the first time step
    temp_at_t <- other_params(params)$ocean_temp[t + params@other_params$other$t_idx,]
  
    # Arrhenius equation
    unscaled_temp_effect <- (exp(25.22 - (0.63/((8.62e-5)*(273 + temp_at_t)))))
    
    # Arrhenius equation scaled to a value between 0 and 1
    temp_effect_metabolism <- 
        (unscaled_temp_effect - species_params(params)$metab_min) /
        species_params(params)$metab_range
    
    # Set temperature effect to 0 if temperatures are outside thermal 
    # tolerance limits
    above_max <- temp_at_t > species_params(params)$temp_max
    below_min <- temp_at_t < species_params(params)$temp_min
    temp_effect_metabolism[above_max | below_min] = 0
  
  # Apply scaled Arrhenius value to metabolism
    sweep((1 - feeding_level) * encounter, 1,
          species_params(params)$alpha, "*", check.margin = FALSE) - 
        metab(params)*temp_effect_metabolism  
      
}

# Set up new resource forcing "function" - just changes to different time slot in the n_pp_array array
plankton_forcing <- function(params, t, ...) {
  w_cut_off <- 10
  pkt <- 10^(other_params(params)$n_pp_array[t + params@other_params$other$t_idx,])/params@dw_full # converting to density
  pkt[which(as.numeric(names(pkt)) >= w_cut_off)] <- 0
  
  return(pkt)  
}
```

# Setting up params objects

The ecosystem is calibrated and the time series to force planktong and temperature are ready. Time to combine everything.

Loading params without any temperature so easy to edit with block below

```{r}
sim <- readRDS("params/params10.RDS")
params <- sim@params
first_year <- 1950
last_year <- 2093
times <- seq(first_year,last_year, by = 1)

## Setting up temperature range

species_params(params)$temp_min <- c(1.8,-1.1,1.3,1.3,-0.1,-1.8,1.4,1.8,1.6) # fishbase
# species_params(params)$temp_min <- c(1.4,-1.1,1.3,1.3,-0.1,-1.8,1.4,1.4,1.4) # adjusted so species survive historical temperatures

# species_params(params)$temp_max <- c(8.8,2.9,2.5,2.8,1.4,2,2.3,3.1,3.9) #fishbase
species_params(params)$temp_max <-   c(8.8,2.9,2.5,2.8,2.4,2.4,2.3,3.1,3.9) # adjusted


## Time index
other_params(params)$t_idx = -1949 # temperature array starts at 1950 so any time generated by the effort array will match the rownumber of the temperature array

## Create parameter for scaling encounter and mortality rates so scalar is always between 0 and 1
species_params(params)$encounterpred_scale <- 
    rep(NA, nrow(species_params(params)))

for (indv in seq(1:length(species_params(params)$temp_min))) {
    
    # Create a vector of all temperatures each species might encounter
    temperature <- seq(species_params(params)$temp_min[indv], 
                       species_params(params)$temp_max[indv], 
                       by = 0.1)
    
    # Find the maximum value of the unscaled effect of temperature on encounter
    # and predation rate for each species 
  species_params(params)$encounterpred_scale[indv] <- 
      max((temperature) * 
              (temperature - species_params(params)$temp_min[indv]) *
              (species_params(params)$temp_max[indv] - temperature)
          )
}

## Determine the minimum, maximum, and range of value for the effect of 
# temperature on metabolism
    
min_metab_value <- 
    (exp(25.22 - (0.63/((8.62e-5)*(273 + species_params(params)$temp_min)))))
max_metab_value <- 
    (exp(25.22 - (0.63/((8.62e-5)*(273 + species_params(params)$temp_max)))))
    
species_params(params)$metab_min <- min_metab_value
species_params(params)$metab_range <- max_metab_value - min_metab_value

```


Set the new rate functions and new resource

```{r}

params <- setRateFunction(params, "Encounter", "therMizerEncounter")
params <- setRateFunction(params, "PredRate", "therMizerPredRate")
params <- setRateFunction(params, "EReproAndGrowth", "therMizerEReproAndGrowth")

params <- setResource(params, resource_dynamics = "plankton_forcing")

```
Adding fisheries to the mix

```{r}

ll_area_yr <- read_csv("ll_area_yr.csv")

ll_trends <- cbind(ll_trends,ll_area_yr[-dim(ll_area_yr)[1],3])

ll_km2 <- data.frame("year" = ll_trends$Year, "effort" = ll_trends$Effort/ll_trends$area_km,
                     "catchT" = ll_trends$CatchT / ll_trends$area_km)
ll_km2$catchT <- ll_km2$catchT * 1e6 #in grams
ll_avg <- mean(ll_km2$catchT)
effort_avg <-mean(ll_km2$effort)

effort <-array(ll_km2$effort, dim = c(length(ll_km2$effort),1), 
                 dimnames = list("time" = ll_km2$year, "gear" = params@gear_params$gear[1]))

```


Set the scenarios

```{r}

# Create parameter objects
params_IPSL_picontrol <- params
params_IPSL_ssp1rcp26 <- params
params_IPSL_ssp5rcp85 <- params

# Attach temperature
other_params(params_IPSL_picontrol)$ocean_temp <- readRDS("processed/IPSL_ocean_temp_array_PIcontrol.RDS")
other_params(params_IPSL_ssp1rcp26)$ocean_temp <- readRDS("processed/IPSL_ocean_temp_array_CCscenario_126.RDS")
other_params(params_IPSL_ssp5rcp85)$ocean_temp <- readRDS("processed/IPSL_ocean_temp_array_CCscenario_585.RDS")

# Attach plankton
other_params(params_IPSL_picontrol)$n_pp_array <- readRDS("processed/IPSL_n_pp_array_PIcontrol.RDS")
other_params(params_IPSL_ssp1rcp26)$n_pp_array <- readRDS("processed/IPSL_n_pp_array_CCscenario_126.RDS")
other_params(params_IPSL_ssp5rcp85)$n_pp_array <- readRDS("processed/IPSL_n_pp_array_CCscenario_585.RDS")


```


```{r}
sim <- project(params_IPSL_ssp1rcp26, effort = effort)
```

simulation using historical data works well, picontrol doesn't


```{r}

mizer::plotBiomass(sim)
mizer::plotSpectra(sim)

```


```{r}
res <- mizer::plotYield(sim,return_data = T)
res$ObservedYield <- ll_km2$catchT

ggplot(res, aes(x = Year)) +
  geom_line(aes(y = Yield)) +
  geom_line(aes(y = ObservedYield), color = "red")
```


# New calibration

Redo previous calibration with temperature 


```{r}
getErrorCustom <- function(vary, params, dat, times, tol = 0.001, 
    timetorun = 10)
{
  params@species_params$R_max[1:9]<-10^vary[1:9]
  params@species_params$erepro[1:9]<-vary[10:18]
  params@species_params$interaction_resource[1:9] <- vary[19:27]

  params <- setParams(params)

  interaction <- params@interaction
  interaction[] <- matrix(vary[28:108],nrow = 9) # stop at 54 if looking only at 3 biggest species
  
  params <- setInteraction(params,interaction)

    # params <- projectToSteady(params, distance_func = distanceSSLogN, 
    #     tol = tol, t_max = length(times), return_sim = F)
    
    sim <- project(params,t_max = length(times),t_start = 1950, progress_bar = F,initial_n =  params@initial_n, initial_n_pp = params@other_params$other$n_pp_array[1,])
    
 # get biomass through time
  biomass <- sweep(sim@n, 3, sim@params@w * sim@params@dw, "*")
  biomass <- biomass[which(dimnames(biomass)$time == "2003"):which(dimnames(biomass)$time == "2020"),,] # trageting fishing period
  
  #get yield through time from model:
  
  f_gear<-mizer::getFMortGear(params,effort)
  # f_gear <- f_gear[1:13,,,,drop=F]
  yield_species_gear <- apply(sweep(f_gear, c(1, 3, 4), biomass, "*"),
                              c(1, 2, 3), sum)
  # yield_species_gear
  
  yield_species <-apply(yield_species_gear, c(1, 3), sum)
  
  yield_frame <- melt(yield_species)
  
  # leave out spin up and change units to tonnes    
  # y<-yield_frame[yield_frame$time >= 1947,]
  
  # disregard zeroes - these were NAs only filled in to run the model   
  
  obs<-dat$catchT
  pred<-yield_frame$value[1:18] # only selecting D.ele for now
  
  # sum of squared errors, could use  log-scale of predictions and data (could change this or use other error or likelihood options)
  
  error <- sum((log(pred[1:13]) - log(obs[1:13]))^2,na.rm=T)

    return(error)
}



```

```{r}
tic()
dat <- ll_km2

  effort <-array(dat$effort, dim = c(length(dat$effort),1), 
                 dimnames = list("time" = dat$year, "gear" = params@gear_params$gear[1]))

# create set of params for the optimisation process
params_optim <- sim@params
# params_optim@other_params$other$t_idx <- 1  # t_Start doesn't work in project to steady so always starts at 0
# vary<-c(log10(params_optim@species_params$R_max),
        # params_optim@species_params$erepro,
        # params_optim@gear_params$catchability[1])


vary<-c(log10(params_optim@species_params$R_max),
        params_optim@species_params$erepro,
        params_optim@species_params$interaction_resource,
        params_optim@interaction)


params_optim<-setParams(params_optim)
# set up workers
noCores <- parallel::detectCores() - 1 # keep some spare core
cl <- parallel::makeCluster(noCores, setup_timeout = 0.5)
setDefaultCluster(cl = cl)
clusterExport(cl, varlist = "cl",envir=environment())
clusterEvalQ(cl, {
  library(mizerExperimental)
  library(optimParallel)
})
optim_result <- optimParallel::optimParallel(par=vary,getErrorCustom,params=params_optim, dat = ll_km2, effort = effort, times = times,
                                             method   ="L-BFGS-B", 
                                             lower=c(rep(3,9),rep(1e-10,9),rep(.1,9),rep(.1,81)),
                                             upper= c(rep(15,9),rep(1,9),rep(.99,9),rep(.99,81)),
                                             parallel=list(loginfo=TRUE, forward=TRUE))#,
                                             #plankton_forcing, therMizerEncounter, therMizerPredRate, therMizerEReproAndGrowth, scaled_temp_fun)
stopCluster(cl)

toc()
saveRDS(optim_result, file="params/optim_result_temperature.RDS")
```



# Predictions

Constant effort


```{r}

effort_cst <- array(data = c(effort,rep(effort[13],(2093-2002-18))), dim = c(2093-2002,1), dimnames = list("time" = 2003:2093, "gear" = "longline"))

sim <- project(params_IPSL_ssp1rcp26, effort = effort_cst)

mizer::plotBiomass(sim)
mizer::plotSpectra(sim)

res <- mizer::plotYield(sim,return_data = T)
res$ObservedYield <- c(ll_km2$catchT, rep(NA,(2093-2002-18)))

ggplot(res, aes(x = Year)) +
  geom_line(aes(y = Yield)) +
  geom_line(aes(y = ObservedYield), color = "red")

```

No fishing

```{r}


sim <- project(params_IPSL_ssp1rcp26, 
               initial_n_pp = params_IPSL_ssp1rcp26@other_params$other$n_pp_array[1,],
                                      t_max = length(times),t_start = 1950)

mizer::plotBiomass(sim)
mizer::plotSpectra(sim, time_range = 2045)


```

```{r}


sim <- project(params_IPSL_ssp5rcp85, 
               initial_n_pp = params_IPSL_ssp5rcp85@other_params$other$n_pp_array[1,],
                                      t_max = length(times),t_start = 1950)

mizer::plotBiomass(sim)
mizer::plotSpectra(sim)
plotDiet2(sim)

```

meeting tuesday 2 hours 10 to 12

# Plots

6.	%Change in biomass for all species under projections relative to biomass averaged over recent period (2000s?).
7.	%Change in catches for toothfish under projections relative to biomass averaged over recent period (2000s?).
8.	%Change in mean body size for all species under projections relative to biomass averaged over recent period (2000s?).

